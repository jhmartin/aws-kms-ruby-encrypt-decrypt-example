version: '2.1'
jobs:
   build:
     environment:
      AWS_PROFILE: OIDC-PROFILE
     docker:
       - image: cimg/ruby:2.7.0
     steps:
       - checkout

      - aws-cli/setup:
          role-arn: "arn:aws:iam::186675908400:role/circleci-kms"
          aws-region: "us-east-1"
          # optional parameters
          profile-name: "OIDC-PROFILE"
          role-session-name: "CircleCI"
          session-duration: "1800"

       # Restore bundle cache
       - type: cache-restore
         key: bundle-{{ checksum "Gemfile.lock" }}

      # Bundle install dependencies
       - run: bundle install --path vendor/bundle

       # Store bundle cache
       - type: cache-save
         key: bundle-{{ checksum "Gemfile.lock" }}
         paths:
           - vendor/bundle

       - run: bash -x ./test.sh
